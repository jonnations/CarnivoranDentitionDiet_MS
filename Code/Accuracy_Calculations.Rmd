---
title: "Accuracy Predictions & IC Scores"
---

#ASSEMBLE PREDICTIONS AND IC SCORES

```{r}
pacman::p_load(tidyverse, brms, geiger, purrr, kableExtra, furrr, here)
scale2 <- function(x, na.rm = TRUE) (x - mean(x, na.rm = na.rm)) / sd(x, na.rm)
add1 <- function(x, na.rm = TRUE) (x + 1)
# Read Tree
phylo <- ape::read.nexus(here("Data", "Carnivora_MCC_2.tre"))

# Read fossil data and calculate body size estimate ^1/3
fos_dat_1 <- read_csv(here("Data", "fossil_carnivoran_data.csv")) %>% 
  mutate(log_cuberoot_mass = log(mass_kg^(1/3)))
# Read extant data
dat <- read.delim(here("Data", "Master_Data.txt")) %>% 
  mutate(mass_kg = exp(log_cuberoot_mass)^3,
         phylo = Species) %>% 
  # drop taxa with missing m2 data
  drop_na(m2_dne) %>% 
  #combine extant and fossil dat for tip dropping and standardizing
  bind_rows(fos_dat_1) %>% 
  # Standardize all data together
  mutate_at(vars(4:11), scale2) %>% 
  mutate_at(vars(12:24), add1) %>% 
  mutate_at(vars(12:24), as.ordered) 
row.names(dat)<-dat$Species
# Remove extra tips (but keep fossil tips!)
carn_treedata<-treedata(phylo, dat, warnings = FALSE)
phylo<-carn_treedata$phy
dat1 <- dat %>% drop_na(bird)
```


### Weights
read in and clean up weights 
```{r}
wts <- read_csv(here("Data", "Test_weights_all.csv")) %>% 
  separate(metric, c("prior", "metric")) %>% 
  rename(item = diet,
         weight = value) %>% 
  mutate(prior = recode(prior,
                        "mn" = "normal",
                        "ms" = "student",
                        "md" = "dirichlet"))
```



## Functions  
```{r}
ord_pred <- function(model){
  d <-  predict({{model}}, summary = T, probs = c(0.055, 0.945))
  d2 <- as.data.frame(d) %>% 
    mutate(actual = as.factor({{model}}[[2]][[1]]), 
           pred   = colnames(d)[max.col(d,ties.method="first")], 
           pred   = str_remove(pred,"P\\(Y = "), pred   = str_remove(pred,"\\)"), 
           actual = factor(actual, ordered = FALSE), 
           pred   = factor(pred), 
           Species = rownames({{model}}[[2]])) %>% 
    as_tibble()  %>% 
    mutate(actual_n = as.numeric(as.character(actual)),
           pred_n = as.numeric(as.character(pred)),
           dif = abs(actual_n - pred_n)) %>%
    select(Species, actual, pred, dif)
  d3 <- tibble(pareto_k = {{model}}[[15]][[1]][[3]][[1]],
            Species = rownames({{model}}[[2]]),
            item = colnames({{model}}[[2]])[1],
            metric = colnames({{model}}[[2]])[2]) %>% mutate_if(is.numeric, round, digits = 3)
  d2 %>% full_join(d3, by = 'Species') %>%  
    mutate(metric = recode(metric, 
                        "m1_dne" = "DNE",
                        "RFI_m1" = "RFI",
                        "m1_opcr" = "OPCR",
                        "log_cuberoot_mass" = "ALL")) %>% 
    left_join(wts, by = c('item','metric'))
}

ord_pred_2 <- function(df){
  map(df, ~ord_pred(.x)) %>% bind_rows()
}

pred_means <- function(dfs){
  dfs %>%  mutate(pred = as.numeric(as.character(pred)),
               actual = as.numeric(as.character(actual)),
               w_pred = (pred * weight),
               w_pareto = pareto_k * weight) %>% 
  group_by(Species, item) %>% 
  summarise(actual = mean(actual),
            pred = mean(pred),
            pareto_k = mean(w_pareto)) %>% 
  mutate_at(c('pareto_k'),  round, digits = 3) %>% 
  mutate(dif = abs(actual - pred),
         pred_round = round(pred, digits = 0),
         dif_round = abs(actual - pred_round))

}
```


# Calculate Model Averaged Prediction Scores
For each taxon for each food item
Do this 1000 times, generating a posterior prediction distribution of 1000 samples per species
Warning, takes around 1 hour to run using 4 cores. The future options set the numbers of cores and workers. 
`tic()` and `toc()` just count the time. 
```{r}
d <- list.files(path=here("Code/Models/mod_outputs"), pattern = ".Rds$", full.names = TRUE) 
df_list <- setNames(lapply(d, readRDS), tools::file_path_sans_ext(d))


furrr_options(seed = TRUE)
options(future.rng.onMisuse="ignore")
plan(multisession, workers = 4)

#tictoc::tic()
dt_n <- furrr::future_map(1:1000, ~ord_pred_2(df_list)) %>% bind_rows() 
#tictoc::toc()

pred_db <- dt_n %>% 
  bind_rows() %>% pred_means() %>% write_csv(file = here("Data", "prediction_table.csv"))
```
#### Prediction Table For SI  

```{r}
pred_db <- read_csv(file = here("Data", "prediction_table.csv")) %>% 
  select(Species, item, pareto_k) %>% arrange(item) %>% 
  kbl(format = "latex") %>% 
  kable_classic(full_width = F) -> tt
tt
writeLines(tt,  here("Data", "Pareto_Table.tex"))
  
```


## Calculate Accuracy

To generate these estimates, we took 1000 draws from the model-averaged posterior distributions from each food item, then calculated the accuracy of each predicted rank. These values are the mean accuracy scores of the 1000 draws.
```{r}
pred_db <- read_csv(file = here("Data", "prediction_table.csv"))
pred_db %>% 
  group_by(item) %>% 
   summarise(n1 = sum(dif_round == 0),
             n2 = sum(dif_round  %in% c(0,1)),
             perfect_match = (n1/89) * 100,
             within_1 = (n2/89) * 100) %>% 
  mutate_if(is.numeric, round, digits = 1) %>% 
  select(!c(n2, n1)) %>% 
  arrange(desc(perfect_match)) #%>% write_csv(file = here("Data", "Accuracy_Table.csv")) #%>% 
#laTex table for manuscript submission
 # arrange(item) %>% 
 # kbl(format = "latex") %>% 
 # kable_classic(full_width = F) #-> tt
#tt
#writeLines(tt, "Accuracy_Table.tex")
```
