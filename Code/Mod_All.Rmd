---
title: "Run All Models"
#output: html_notebook
---

#Run all models in one script
This script reads in the scripts and runs the models one by one, so we don't have to open each model script individually. This way the data only has to be loaded once, and wrangled once. 

The outputs are stored in the `~Code/Models/mod_outputs` file. Note: Just the models with the highest looic weights are saved. If weight = 0, then the model is not saved. We did this using the `brms::model_weights(., weights = "stacking")` command. 


#Setup

#### Files and Functions
```{r}
pacman::p_load(tidyverse, rmarkdown, brms, cmdstanr, phytools, geiger, caret, here)

here::i_am('Code/Mod_All.Rmd')

# Dirichlet Script
source("Dirichlet_Prior.R")
#Functions
scale2 <- function(x, na.rm = TRUE) (x - mean(x, na.rm = na.rm)) / sd(x, na.rm)
add1 <- function(x, na.rm = TRUE) (x + 1)
options(brms.backend = "cmdstanr")
```

#### Read and Wrangle Data
```{r}
# Read Tree
phylo <- ape::read.nexus(here("Data", "Carnivora_MCC_2.tre"))

# Read fossil data and calculate body size estimate ^1/3
fos_dat_1 <- read_csv(here("Data", "fossil_carnivoran_data.csv")) %>% 
  mutate(log_cuberoot_mass = log(mass_kg^(1/3)))
# Read extant data
dat <- read.delim(here("Data", "Master_Data.txt")) %>% 
  mutate(mass_kg = exp(log_cuberoot_mass)^3,
         phylo = Species) %>% 
  # drop taxa with missing m2 data
  drop_na(m2_dne) %>% 
  #combine extant and fossil dat for tip dropping and standardizing
  bind_rows(fos_dat_1) %>% 
  # Standardize all data together
  mutate_at(vars(4:11), scale2) %>% 
  mutate_at(vars(12:24), add1) %>% 
  mutate_at(vars(12:24), as.ordered) 


row.names(dat)<-dat$Species
# Remove extra tips (but keep fossil tips!)
carn_treedata<-treedata(phylo, dat, warnings = FALSE)
phylo<-carn_treedata$phy
A <- ape::vcv.phylo(phylo, corr = TRUE)


#Separate the model inputs
dat1 <- dat %>% drop_na(bird)

```

#Run Models 
These scripts run the models, generate the rds files, and generate the `Test_weights_all.csv` file. 
```{r include=FALSE}
render(here("Code/Models", "Mod_Bird.Rmd"))
render(here("Code/Models", "Mod_Carrion.Rmd"))
render(here("Code/Models", "Mod_Egg.Rmd"))
render(here("Code/Models", "Mod_Fish.Rmd"))
render(here("Code/Models", "Mod_Fruit.Rmd"))
render(here("Code/Models", "Mod_Hard_Invert.Rmd"))
render(here("Code/Models", "Mod_Herptile.Rmd"))
render(here("Code/Models", "Mod_Large_Mammal.Rmd"))
render(here("Code/Models", "Mod_Plant.Rmd"))
render(here("Code/Models", "Mod_Root.Rmd"))
render(here("Code/Models", "Mod_Seed.Rmd"))
render(here("Code/Models", "Mod_Small_Mammal.Rmd"))
render(here("Code/Models", "Mod_Soft_Invert.Rmd"))
```

