---
title: "Posterior Prediction Model averaging"
author: "Jon Nations"
date: "3/7/2022"
---

# Use Model Averaging to generate Posterior Prediction Plots

Posterior Predictive Checks show the distribution of the predictions along with the empirical values. This allows visual comparisons. We use the `ppc_bars` plot from the bayesplot package, which works best with the ordinal response variable.

Here we estimate the model weights of each food type, then run 1000 predictions with n(weight) predictions for each model.

```{r}
pacman::p_load(phytools, geiger, tidyverse, patchwork, tidybayes, bayesplot)

options(dplyr.summarise.inform = FALSE)
scale2 <- function(x, na.rm = TRUE) (x - mean(x, na.rm = na.rm)) / sd(x, na.rm)
add1 <- function(x, na.rm = TRUE) (x + 1)
```

# Data
Results in dat (all extant w data), fos_dat (fossils), and c_dat (cryptic). Also weights is the model weights
```{r}
# Read fossil data and calculate body size estimate ^1/3
fos_dat_1 <-  read_csv(here("Data", "fossil_carnivoran_data.csv")) %>% 
  mutate(log_cuberoot_mass = log(mass_kg^(1/3)))
# Read extant data
dat <- read.delim(here("Data", "Master_Data.txt")) %>% 
  mutate(mass_kg = exp(log_cuberoot_mass)^3,
         phylo = Species) %>% 
  # drop taxa with missing m2 data
  drop_na(m2_dne) %>% 
  #combine extant and fossil dat for tip dropping and standardizing
  bind_rows(fos_dat_1) %>% 
  # Standardize all data together
  mutate_at(vars(4:11), scale2) %>% 
  mutate_at(vars(12:24), add1) %>% 
  mutate_at(vars(12:24), as.ordered) 

rm(fos_dat_1)
row.names(dat)<-dat$Species

fos_dat <- dat %>% drop_na(m1_tooth_length)
cryp_sp <- c("Arctogalidia_trivirgata", "Bassaricyon_alleni", "Catopuma_badia", "Chrotogale_owstoni", "Cynogale_bennettii", "Galidia_elegans", "Galidictis_fasciata", "Hemigalus_derbyanus", "Herpestes_brachyurus", "Mydaus_javanensis", "Paradoxurus_musanga", "Pardofelis_marmorata", "Prionodon_linsang")
c_dat <- dat %>% filter(Species %in% cryp_sp)
dat <- dat %>% drop_na(bird)

weights = read_csv(here("Data", "D_weights_all.csv"))
```
# Functions
```{r}
pred<- function(mod, drws){
  dat %>% add_predicted_draws({{mod}}, 
                              allow_new_levels = TRUE,
                              ndraws = {{drws}},
                              value = 'preds') %>% 
  as_tibble()  %>% 
  select(c(Species, preds)) %>% 
group_by(Species) %>% 
  mutate(preds = as.numeric(preds),
         row = row_number()) %>% 
  pivot_wider(names_from = "Species", values_from = "preds") %>% 
  select(-row)
}
```

# Predictions & Plot objects
## Bird
```{r}
bird.w <- weights %>% filter(diet == "bird")
bird.w
```

```{r}
m.bird_RLGA <-  readRDS(here("mod_outputs", "D_RLGA_bird.rds"))
m.bird_RFI <- readRDS(here("mod_outputs", "D_RFI_bird.rds"))
m.bird_all <- readRDS(here("mod_outputs", "D_all_bird.rds"))
# THEse numbers represent the model weights!
pred.bird_RFI <- pred(m.bird_RFI, 70)
pred.bird_RLGA <- pred(m.bird_RLGA, 592)
pred.bird_all <- pred(m.bird_all, 338) 
pred.bird = bind_rows(pred.bird_RFI, pred.bird_RLGA, pred.bird_all) %>% as.matrix()

#(p1 | p2) + plot_layout(guides = "collect")
rm(m.bird_RLGA, m.bird_RFI, m.bird_all, pred.bird_RLGA, pred.bird_RFI, pred.bird_all)

y <- dat$bird %>% as.numeric()

p1 <- ppc_bars(y, pred.bird) + xlab("Bird")
p1

rm(m.bird_RLGA, m.bird_RFI, m.bird_all, pred.bird_RLGA, pred.bird_RFI, pred.bird_all, pred.bird)
```


## Carrion
```{r}
weights %>% filter(diet == "carrion")
```

```{r}
m.carrion_opcr <-  readRDS(here("mod_outputs", "D_opcr_carrion.rds"))
m.carrion_RLGA <- readRDS(here("mod_outputs", "D_RLGA_carrion.rds"))

pred.carrion_OPCR <- pred(m.carrion_opcr, 566) 
pred.carrion_RLGA <- pred(m.carrion_RLGA, 434) 

pred.carrion = bind_rows(pred.carrion_OPCR, pred.carrion_RLGA) %>% as.matrix()


y <- dat$carrion %>% as.numeric()

p2 <- ppc_bars(y, pred.carrion) + xlab("Carrion")
p2

rm(m.carrion_opcr, m.carrion_RLGA, pred.carrion_OPCR, pred.carrion_RLGA, pred.carrion)
```
##Egg
```{r}
weights %>% filter(diet == "egg")
```

```{r}
m.egg_rfi <-  readRDS(here("mod_outputs", "D_RFI_egg.rds"))
m.egg_dne <- readRDS(here("mod_outputs", "D_dne_egg.rds"))

pred.egg_rfi <- pred(m.egg_rfi, 818) 
pred.egg_dne <- pred(m.egg_dne, 182)

pred.egg = bind_rows(pred.egg_rfi, pred.egg_dne) %>% as.matrix()

y <- dat$egg %>% as.numeric()

p3 <- ppc_bars(y, pred.egg) + xlab("Egg")

rm(m.egg_dne, m.egg_rfi, pred.egg, pred.egg_rfi, pred.egg_dne)
```
## Fish

```{r}
weights %>% filter(diet == "fish")
```


```{r}
m.fish_opcr <-  readRDS(here("mod_outputs", "D_opcr_fish.rds"))
m.fish_rlga <- readRDS(here("mod_outputs", "D_RLGA_fish.rds"))

pred.fish_opcr <- pred(m.fish_opcr, 268) 
pred.fish_rlga <- pred(m.fish_rlga, 732) 

pred.fish = bind_rows(pred.fish_opcr, pred.fish_rlga) %>% as.matrix()

y <- dat$fish %>% as.numeric()

p4 <- ppc_bars(y, pred.fish) + xlab("Fish")

rm(m.fish_rlga, m.fish_opcr, pred.fish, pred.fish_opcr, pred.fish_rlga)
```

## Fruit

```{r}
weights %>% filter(diet == "fruit")
```

```{r}
m.fruit_rfi <- readRDS(here("mod_outputs", "D_RFI_fruit.rds"))
m.fruit_opcr <-  readRDS(here("mod_outputs", "D_opcr_fruit.rds"))
m.fruit_rlga <- readRDS(here("mod_outputs", "D_RLGA_fruit.rds"))

pred.fruit_rfi <- pred(m.fruit_rfi, 282)
pred.fruit_opcr <- pred(m.fruit_opcr, 618) 
pred.fruit_rlga <- pred(m.fruit_rlga, 100) 


pred.fruit <- bind_rows(pred.fruit_rfi, pred.fruit_opcr, pred.fruit_rlga) %>% as.matrix()

y = dat$fruit %>% as.numeric()

p5 <- ppc_bars(y, pred.fruit) + xlab("Fruit")

rm(m.fruit_rlga, m.fruit_opcr, m.fruit_rfi, pred.fruit, pred.fruit_opcr, pred.fruit_rfi, pred.fruit_rlga)
```


## Hard Invert

```{r}
weights %>% filter(diet == "hard_invert")
```

```{r}
m.hard_dne <- readRDS(here("mod_outputs", "D_dne_hard_invert.rds"))
m.hard_all <-  readRDS(here("mod_outputs", "D_all_hard_invert.rds"))
m.hard_rlga <- readRDS(here("mod_outputs", "D_RLGA_hard_invert.rds"))

pred.hard_dne <- pred(m.hard_dne, 283)
pred.hard_rlga <- pred(m.hard_rlga, 168) 
pred.hard_all <- pred(m.hard_all, 549) 

pred.hard <- pred.hard<- bind_rows(pred.hard_all, pred.hard_rlga, pred.hard_dne) %>% as.matrix()

y = dat$hard_invert %>% as.numeric()

p6 <- ppc_bars(y, pred.hard) + xlab("Hard Invert")

rm(m.hard_rlga, m.hard_all, m.hard_dne, pred.hard_all, pred.hard_rlga, pred.hard_dne, pred.hard)
```

## Herptile

```{r}
weights %>% filter(diet == "herptile")
```

```{r}
m.herp_rfi <- readRDS(here("mod_outputs", "D_RFI_herptile.rds"))
m.herp_dne <- readRDS(here("mod_outputs", "D_dne_herptile.rds"))
m.herp_opcr <- readRDS(here("mod_outputs", "D_opcr_herptile.rds"))
m.herp_rlga <- readRDS(here("mod_outputs", "D_RLGA_herptile.rds"))
m.herp_all <-  readRDS(here("mod_outputs", "D_all_herptile.rds"))

pred.herp_rfi <- pred(m.herp_rfi, 6)
pred.herp_dne <- pred(m.herp_dne, 748)
pred.herp_opcr <- pred(m.herp_opcr, 152) 
pred.herp_rlga <- pred(m.herp_rlga, 88)
pred.herp_all <- pred(m.herp_all, 6) 

pred.herp <- bind_rows(pred.herp_all, pred.herp_dne, pred.herp_opcr, pred.herp_rfi, pred.herp_rlga) %>% as.matrix()

y = dat$herptile %>% as.numeric()

p7 <- ppc_bars(y, pred.herp) + xlab("Herptile")

rm(pred.herp_all, pred.herp_dne, pred.herp_opcr, pred.herp_rfi, pred.herp_rlga, m.herp_all, m.herp_rlga, m.herp_opcr, m.herp_dne, m.herp_rfi)

```

## Large Mammal
```{r}
weights %>% filter(diet == "large_mammal")
```

Large Mammal uses RLGA, and All
```{r}
m.large_RLGA <-  readRDS(here("mod_outputs", "D_RLGA_large_mammal.rds"))
m.large_all <- readRDS(here("mod_outputs", "D_all_large_mammal.rds"))

pred.large_RLGA <- pred(m.large_RLGA, 650) 
pred.large_all <- pred(m.large_all, 350) 

pred.large <- bind_rows(pred.large_all, pred.large_RLGA) %>% as.matrix()

y = dat$large_mammal %>% as.numeric()

p8 <- ppc_bars(y, pred.large) + xlab("Large Mammal")

rm(m.large_RLGA, m.large_all, pred.large_RLGA, pred.large_all)
```


## Plant

```{r}
weights %>% filter(diet == "plant")
```

```{r}
m.plant_opcr <-  readRDS(here("mod_outputs", "D_opcr_plant.rds"))
m.plant_dne <- readRDS(here("mod_outputs", "D_dne_plant.rds"))

pred.plant_opcr <- pred(m.plant_opcr, 610) 
pred.plant_dne <- pred(m.plant_dne, 390) 

pred.plant <- bind_rows(pred.plant_opcr, pred.plant_dne) %>% as.matrix()

y = dat$plant %>% as.numeric()

p9 <- ppc_bars(y, pred.plant) + xlab("Plant")

rm(m.plant_dne, m.plant_opcr, pred.plant_opcr, pred.plant_dne)
```

## Root

```{r}
weights %>% filter(diet == "root")
```

```{r}
m.root_rlga <-  readRDS(here("mod_outputs", "D_rlga_root.rds"))

pred.root <- pred(m.root_rlga, 1000) %>% as.matrix()

y = dat$root%>% as.numeric()

p10 <- ppc_bars(y, pred.root) + xlab("Root")  + xlim(0.5,4.5)

rm(m.root_rlga, pred.root)
```

## Seed

```{r}
weights %>% filter(diet == "seed")
```

```{r}
m.seed_rlga <-  readRDS(here("mod_outputs", "D_RLGA_seed.rds"))
m.seed_dne <- readRDS(here("mod_outputs", "D_dne_seed.rds"))

pred.seed_rlga <- pred(m.seed_rlga, 185) 
pred.seed_dne <- pred(m.seed_dne, 815) 

pred.seed <- bind_rows(pred.seed_rlga, pred.seed_dne) %>% as.matrix()

y = dat$seed %>% as.numeric()

p11 <- ppc_bars(y, pred.seed) + xlab("Seed")

rm(m.seed_dne, m.seed_rlga, pred.seed_rlga, pred.seed_dne)
```


## Small Mammal

```{r}
weights %>% filter(diet == "small_mammal")
```

```{r}
m.small_rlga <-  readRDS(here("mod_outputs", "D_RLGA_small_mammal.rds"))
m.small_dne <- readRDS(here("mod_outputs", "D_dne_small_mammal.rds"))

pred.small_rlga <- pred(m.small_rlga, 789) 
pred.small_dne <- pred(m.small_dne, 211) 

pred.small <- bind_rows(pred.small_rlga, pred.small_dne) %>% as.matrix()

y = dat$small_mammal%>% as.numeric()

p12 <- ppc_bars(y, pred.small) + xlab("Small Mammal")

rm(m.small_dne, m.small_rlga, pred.small_rlga, pred.small_dne)
```


## Soft Invert

```{r}
weights %>% filter(diet == "soft_invert")
```

```{r}
m.soft_opcr <-  readRDS(here("mod_outputs", "D_opcr_soft_invert.rds"))
m.soft_dne <- readRDS(here("mod_outputs", "D_dne_soft_invert.rds"))

pred.soft_opcr <- pred(m.soft_opcr, 96)
pred.soft_dne <- pred(m.soft_dne, 904) 

pred.soft <- bind_rows(pred.soft_opcr, pred.soft_dne) %>% as.matrix()

y = dat$soft_invert %>% as.numeric()

p13 <- ppc_bars(y, pred.soft) + xlab("Soft Invert")

rm(m.soft_dne, m.soft_opcr, pred.soft_opcr, pred.soft_dne)
```

# Plot

```{r}
(p1 + p2) / (p3 + p4) / (p5 + p6) / (p7 + p8) / (p9 + p10) / (p11 + p12) / (p13 + plot_spacer()) + plot_layout(guides = "collect") + plot_annotation(title = "Posterior Predictive Checks") & 
  theme(text=element_text(family=""))

ggsave(here("Plots", "Weighted_PP_Checks_Supp.pdf", height = 13, width = 8.5))

(p1 + p2) / (p3 + p4) / (p5 + p6) / (p7 + p8) / (p9 + p10) / (p11 + p12) / (p13 + plot_spacer()) + plot_layout(guides = "collect") + plot_annotation(title = "Posterior Predictive Checks") & 
  theme(text=element_text(family=""))
ggsave(here("Plots", "Weighted_PP_Checks_Supp.png", height = 13, width = 8.5))
```

